<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/safari-pinned-tab.svg" rel="mask-icon" color="#3BA3E8"><link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name="viewport"><meta content="#2d89ef" name="msapplication-TileColor"><meta content="#8a73ff" name="theme-color"><link href="/manifest.json" rel="manifest"><title>Geordie Powers</title><link href="/static/css/main.7e2b7afe.chunk.css" rel="stylesheet"><link href="/static/js/16.685cfdbc.chunk.js" rel="preload" as="script"><link href="/static/js/main.c79bbdec.chunk.js" rel="preload" as="script"><link href="/static/js/14.25c1c560.chunk.js" rel="preload" as="script"><link href="/static/js/5.4600a1b2.chunk.js" rel="preload" as="script"><link href="/static/js/3.c7af5567.chunk.js" rel="preload" as="script"></head><body><div id="root"><div class="Layout Layout--standard fastFade"><nav class="u-flexH u-spaceBetween u-centerMain"><div><a href="/"><svg class="LogoSvg" enable-background="new 0 0 200 200" height="200px" id="Layer_1" version="1.1" viewBox="0 0 200 200" width="200px" x="0px" xml:space="preserve" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><linearGradient gradientUnits="userSpaceOnUse" id="SVGID_1_" x1="148.8818" x2="51.1174" y1="15.3335" y2="184.6664"><stop offset="0" style="stop-color:#3ba3e8"></stop><stop offset="1" style="stop-color:#8a73ff"></stop></linearGradient><path d="M148.647,23.135c-28.3,0-51.244,22.944-51.244,51.243v9.72v31.804v9.72 c0,25.432-20.618,46.05-46.05,46.05c-25.432,0-46.051-20.618-46.051-46.05c0-25.432,20.619-46.051,46.051-46.051h28.576v-5.192 H51.353c-28.301,0-51.243,22.942-51.243,51.243s22.942,51.244,51.243,51.244s51.244-22.943,51.244-51.244v-9.72V84.098v-9.72 c0-25.432,20.617-46.05,46.051-46.05c25.433,0,46.05,20.618,46.05,46.05s-20.617,46.051-46.05,46.051h-28.576v5.192h28.576 c28.301,0,51.243-22.942,51.243-51.243C199.891,46.079,176.948,23.135,148.647,23.135z" fill="url(#SVGID_1_)"></path><rect fill="url(#SVGID_1_)" height="5.192" width="17.475" x="62.455" y="120.429"></rect></svg></a></div><div><a href="/projects">Projects</a><a href="/blog">Blog</a><a href="/contact">Contact</a></div></nav><main><div><h1 id="building-swift-shop---week-6-dec-29-2019---jan-04-2020">Building Swift Shop - Week 6 (Dec 29 2019 - Jan 04, 2020)</h1><h3 id="jan-05-2020">Jan 05, 2020</h3><p>The past few weeks have primarily been about improving the product page and its edit form modal. It’s gone through several iterations now, and I think it’s finally in a good place. Here’s a quick overview of the changes:</p><h2 id="pass-1">Pass 1:</h2><pre class="language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token builtin">ProductPage</span><span class="token punctuation">:</span> <span class="token builtin">View</span> <span class="token punctuation">{</span>
  @<span class="token builtin">ObservedObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> model<span class="token punctuation">:</span> <span class="token builtin">ProductPageViewModel</span> <span class="token operator">=</span> <span class="token function">ProductPageViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token builtin">State</span> <span class="token keyword">var</span> editSheetOpen <span class="token operator">=</span> <span class="token boolean">false</span>
  @<span class="token builtin">State</span> <span class="token keyword">var</span> editedProduct<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token operator">?</span>
  @<span class="token builtin">State</span> <span class="token keyword">var</span> isNewProduct <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">addProductClicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    isNewProduct <span class="token operator">=</span> <span class="token boolean">true</span>
    editedProduct <span class="token operator">=</span> <span class="token function">SimpleProduct</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> price<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">productRowClicked</span><span class="token punctuation">(</span>product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    isNewProduct <span class="token operator">=</span> <span class="token boolean">false</span>
    editedProduct <span class="token operator">=</span> product
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">onSaveProduct</span><span class="token punctuation">(</span><span class="token number">_</span> product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">,</span> isNew<span class="token punctuation">:</span> <span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">onSaveProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">,</span> isNew<span class="token punctuation">)</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">false</span>
    isNewProduct <span class="token operator">=</span> <span class="token boolean">false</span>
    editedProduct <span class="token operator">=</span> <span class="token constant">nil</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> body<span class="token punctuation">:</span> some <span class="token builtin">View</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>We couple a lot of unnecessary state to the ProductPage here. Why should the product page view have to keep track of what product is being edited, or whether or not it’s new? The only things that should be concerned with <code>isNewProduct</code> should be:<ul><li>The function that brings us into edit mode (add new product, edit existing product), which should set this state</li><li>The <code>onSaveProduct</code> function inside ProductPageViewModel (not shown), which should read the state to decide which database call to make</li></ul></li></ul><h2 id="pass-2">Pass 2:</h2><pre class="language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token builtin">ProductPage</span><span class="token punctuation">:</span> <span class="token builtin">View</span> <span class="token punctuation">{</span>
  @<span class="token builtin">ObservedObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> model<span class="token punctuation">:</span> <span class="token builtin">ProductPageViewModel</span> <span class="token operator">=</span> <span class="token function">ProductPageViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token builtin">State</span> <span class="token keyword">var</span> editSheetOpen <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">private</span> <span class="token keyword">var</span> editFormModel <span class="token operator">=</span> <span class="token function">ProductEditFormModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">addProductClicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    editFormModel<span class="token punctuation">.</span><span class="token function">newProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">productRowClicked</span><span class="token punctuation">(</span>product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">true</span>
    editFormModel<span class="token punctuation">.</span><span class="token function">editProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">onSaveProduct</span><span class="token punctuation">(</span><span class="token number">_</span> product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">,</span> isNew<span class="token punctuation">:</span> <span class="token builtin">Bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">onSaveProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">,</span> isNew<span class="token punctuation">)</span>
    editSheetOpen <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> body<span class="token punctuation">:</span> some <span class="token builtin">View</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><code>isNewProduct</code> moved from page state into ProductEditFormModel — ProductPage no longer has to care about it</li><li>A ProductEditFormModel instance is created in the product page and later passed down to the edit form View constructor — this allows for calling methods on the edit form model directly (<code>newProduct</code> and <code>editProduct</code>)<ul><li>When the “Add Product” button was tapped, we’d set the sheet open status and call <code>newProduct()</code> on the edit form model. This would set <code>isNew</code> to true within the model.</li><li>When a product row was selected for editing, we’d set the sheet open status and call <code>editProduct(product)</code> on the edit form model. The model would accept the given product to edit, and internally set <code>isNew</code> false.</li></ul></li></ul><p>A slight improvement, but what still sucks about this?</p><ul><li>Creating the ProductEditFormModel in a view other than the ProductEditForm itself feels like a strange pattern, and the only win is that we move <code>isNewProduct</code> out of the ProductPage</li><li>Just as ProductPage shouldn’t care about <code>isNewProduct</code>, the edit form shouldn’t either. It should operate on a Product structure, call a function when it’s done, and nothing more</li><li><code>editFormModel.newProduct()</code> is responsible for creating an empty product to operate on. This reduces testability, and if we’re debugging this code, it’s potentially another layer to dig through to find what we’re looking for. It should instead be up to the caller to decide what a “new product” is. Making this change would have been a small amount of work from this point, but pass 3 addresses the issue in a different way.</li></ul><h2 id="pass-3-current-implementation">Pass 3 (Current implementation):</h2><p>The latest iteration wraps most of the needed functionality up into this SheetStatus enum, whose <code>open</code> variant has some associated values:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">enum</span> <span class="token builtin">SheetStatus</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> closed
  <span class="token keyword">case</span> <span class="token function">open</span><span class="token punctuation">(</span>product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">,</span> isNew<span class="token punctuation">:</span> <span class="token builtin">Bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Usage:</p><pre class="language-swift"><code class="language-swift"><span class="token keyword">struct</span> <span class="token builtin">ProductPage</span><span class="token punctuation">:</span> <span class="token builtin">View</span> <span class="token punctuation">{</span>
  @<span class="token builtin">ObservedObject</span> <span class="token keyword">private</span> <span class="token keyword">var</span> model<span class="token punctuation">:</span> <span class="token builtin">ProductPageViewModel</span> <span class="token operator">=</span> <span class="token function">ProductPageViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  @<span class="token builtin">State</span> <span class="token keyword">var</span> editSheetStatus<span class="token punctuation">:</span> <span class="token builtin">SheetStatus</span> <span class="token operator">=</span> <span class="token punctuation">.</span>closed

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">addProductClicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetStatus <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token builtin">SimpleProduct</span><span class="token punctuation">.</span><span class="token function">newEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isNew<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">productRowClicked</span><span class="token punctuation">(</span>product<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    editSheetStatus <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>product<span class="token punctuation">,</span> isNew<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">func</span> <span class="token function">onSaveProduct</span><span class="token punctuation">(</span><span class="token number">_</span> editedProduct<span class="token punctuation">:</span> <span class="token builtin">SimpleProduct</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">.</span><span class="token function">onSaveProduct</span><span class="token punctuation">(</span>product<span class="token punctuation">,</span> editSheetStatus<span class="token punctuation">.</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// isNew here is a helper fn on the enum; () -> Bool</span>
    editSheetStatus <span class="token operator">=</span> <span class="token punctuation">.</span>closed
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> body<span class="token punctuation">:</span> some <span class="token builtin">View</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul><li>ProductPage no longer has to manage the ProductEditFormModel instance — strange pattern gone!</li><li>The sheet open/closed boolean has been replaced with a simple enum property, set to the <code>closed</code> variant by default</li><li>When we edit or add a product we can open the edit sheet, pass a product to operate on (new or existing), and optionally set <code>isNew</code> all in one short expression</li><li>The <code>isNew</code> state now only lives inside the enum variant, and neither the ProductPage nor ProductEditForm views have to store it (In fact, it’s no longer even referenced anywhere outside of the functions shown above)</li></ul><p>This implementation feels much better than any of the others. One of the only caveats is that we can’t use the enum’s value directly for opening and closing the <a href="https://github.com/AndreaMiotto/PartialSheet">PartialSheet</a> view, because it expects to be passed a <code>Binding&lt;Bool></code>. For now, an in-line binding declaration works:</p><pre><code>partialSheet(presented: Binding&lt;Bool>(get: self.editSheetStatus.isOpen, set: self.closeForm)) {
</code></pre><ul><li><code>isOpen</code> is a small helper function defined on the SheetStatus enum</li></ul><pre class="language-swift"><code class="language-swift"><span class="token keyword">extension</span> <span class="token builtin">SheetStatus</span> <span class="token punctuation">{</span>
  <span class="token keyword">func</span> <span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">Bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token keyword">case</span> <span class="token punctuation">.</span>closed <span class="token operator">=</span> <span class="token keyword">self</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul><li><code>self.closeForm</code> is a private ProductPage method that simply sets editSheetStatus to <code>.closed</code>. The compiler doesn’t like us setting the property in an in-line closure, but Xcode doesn’t say why. It instead highlights an unrelated line with a false positive error:</li></ul><div align="center"><a href="/static/media/SwiftShop_wk6_err1.e2a11462.png" target="GP_IMG"><img src="/static/media/SwiftShop_wk6_err1.e2a11462.png" style="max-width:100%"></a></div><p>When the closure <code>set: { self.editSheetStatus = .closed }</code> is removed, the reported false positive is gone and the app compiles:</p><div align="center"><a href="/static/media/SwiftShop_wk6_err2.bad169f9.png" target="GP_IMG"><img src="/static/media/SwiftShop_wk6_err2.bad169f9.png" style="max-width:100%"></a></div><p>This is a great example of how terrible the error reporting in SwiftUI+Xcode is currently. It’s a great loss of productivity, and I hope Apple is putting effort into improving it.</p></div></main></div></div><script>!function(f){function e(e){for(var t,r,n=e[0],o=e[1],a=e[2],c=0,u=[];c<n.length;c++)r=n[c],d[r]&&u.push(d[r][0]),d[r]=0;for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&(f[t]=o[t]);for(p&&p(e);u.length;)u.shift()();return l.push.apply(l,a||[]),i()}function i(){for(var e,t=0;t<l.length;t++){for(var r=l[t],n=!0,o=1;o<r.length;o++){var a=r[o];0!==d[a]&&(n=!1)}n&&(l.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},u={17:0},d={17:0},l=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return f[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(l){var e=[];u[l]?e.push(u[l]):0!==u[l]&&{2:1,6:1}[l]&&e.push(u[l]=new Promise(function(e,n){for(var t="static/css/"+({}[l]||l)+"."+{0:"31d6cfe0",2:"31d49b7e",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"1824b1f2",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"31d6cfe0"}[l]+".chunk.css",o=s.p+t,r=document.getElementsByTagName("link"),a=0;a<r.length;a++){var c=(f=r[a]).getAttribute("data-href")||f.getAttribute("href");if("stylesheet"===f.rel&&(c===t||c===o))return e()}var u=document.getElementsByTagName("style");for(a=0;a<u.length;a++){var f;if((c=(f=u[a]).getAttribute("data-href"))===t||c===o)return e()}var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.onload=e,i.onerror=function(e){var t=e&&e.target&&e.target.src||o,r=new Error("Loading CSS chunk "+l+" failed.\n("+t+")");r.request=t,n(r)},i.href=o,document.getElementsByTagName("head")[0].appendChild(i)}).then(function(){u[l]=0}));var r=d[l];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=d[l]=[e,t]});e.push(r[2]=t);var n,o=document.getElementsByTagName("head")[0],a=document.createElement("script");a.charset="utf-8",a.timeout=120,s.nc&&a.setAttribute("nonce",s.nc),a.src=s.p+"static/js/"+({}[l]||l)+"."+{0:"0206793b",2:"62eb3000",3:"c7af5567",4:"8dd27aae",5:"4600a1b2",6:"990c5257",7:"30ea74c0",8:"7512e075",9:"ebbe1e98",10:"abf27806",11:"0908009d",12:"3054338b",13:"d124050a",14:"25c1c560",15:"bec5874a"}[l]+".chunk.js",n=function(e){a.onerror=a.onload=null,clearTimeout(c);var t=d[l];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,o=new Error("Loading chunk "+l+" failed.\n("+r+": "+n+")");o.type=r,o.request=n,t[1](o)}d[l]=void 0}};var c=setTimeout(function(){n({type:"timeout",target:a})},12e4);a.onerror=a.onload=n,o.appendChild(a)}return Promise.all(e)},s.m=f,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var o=0;o<t.length;o++)e(t[o]);var p=n;i()}([])</script><script src="/static/js/16.685cfdbc.chunk.js"></script><script src="/static/js/main.c79bbdec.chunk.js"></script></body></html>